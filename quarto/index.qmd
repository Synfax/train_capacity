---
format:
  closeread-html:
    theme: zephr
    page-layout: full
    remove-header-space: false
    css: 
      - index.css
      - nav_fixes.css
    image: "index_images/main.png"
    cr-section:
      layout: "overlay-left"
---

```{=html}
<script>
function modifyMainDiv() {
  console.log('blue');
  const mainDiv = document.getElementById('quarto-document-content');
  if (mainDiv) {
    console.log('found');
    mainDiv.classList.remove('column-body');
    mainDiv.classList.add('column-page-right');
    // You can add more class modifications here
  }
}

// This function will be called by the script in the Quarto document
modifyMainDiv();
</script>
```
```{r, message=FALSE, warning=FALSE}

library(tidyverse)
library(sf)
library(leaflet)
library(shiny)
library(htmlwidgets)
library(reactablefmtr)

locations <- readRDS('../r_objects/locations.Rdata')
source('../r/constants.r')

source('../r/theme.r')
source('../r/graphs.r')

transformed_scores <- readRDS('../r_objects/transformed_scores.Rdata')
original_values <- readRDS('../r_objects/station_rankings.Rdata')


# combined_scores <- original_values %>%
#   left_join(transformed_scores, by = 'station') %>%
#   arrange(desc(score)) %>%
#   slice_head(n = 10) %>%
#   mutate(across(where(is.numeric), .fns = function(x) round(x, 2) )) %>%
#   mutate(rank = row_number())


transformed_scores <- readRDS('../r_objects/transformed_scores.Rdata') %>%
  as.data.frame() %>%
  slice_head(n = 10) %>%
  mutate(across(where(is.numeric), .fns = function(x) round(x, 2) )) %>%
  mutate(rank = row_number())

san_station <- function(x) {
  return( str_replace(x, ' ', '_') )
}

# translations = c(
#   'grz_nrz_pc' = 'Zoning suitability',
#   'capacity_delta' = 'Potential new homes',
#   'average_peak_service_freq' = 'Train frequency',
#   'average_peak_service_cap' = 'Available train capacity',
#   'walkability_score' = 'Local services',
#   'distance' = 'Distance to CBD',
#   'n_bus_tram' = 'Other transport infrastructure'
# )

# compact_data_bars <- function(data, fill_color = "#00bfc4", inside_color = "white", outside_color = "black", force_outside = FALSE, ...) {
#   orig_formatter <- reactablefmtr::data_bars(data, fill_color = fill_color, force_outside = force_outside, ...)
#   
#   function(value, index, name) {
#     bar <- orig_formatter(value, index, name)
#     script <- sprintf("
#       const b = this.querySelector('.bar-cell');
#       if (b) {
#         const t = b.querySelector('span');
#         if (t) t.style.color = (b.querySelector('.bar').offsetWidth < b.offsetWidth && %s) ? '%s' : '%s';
#       }
#     ", !force_outside, inside_color, outside_color)
#     
#     tagList(bar, tags$script(HTML(script)))
#   }
# }

translations <- translations <- gsub("\\s*\\([^)]+\\)", "", translations)


printScores <- function(r) {
  
  transformed_scores %>% 
  filter(rank == r) %>%
  pivot_longer(-station) %>%
  select(-station) %>%
  filter(!(name %in% c('score','rank'))) %>%
  mutate(name = translations[name]) %>%
  reactable(
            class = "pageinforeactable",
            columns = list(
              'name' = colDef(name = 'Metric'),
              'value' = colDef(name = "Score",
                             cell = data_bars(.,
                                              text_position = 'above',
                                              fill_color = '#1B5E20',
                                              text_color = 'black',
                                              background = 'opaque',
                                              fill_opacity = 1,
                                              bar_height = 24,
                                              bold_text = T))
            )
            
            ) %>%
  return()
  
}

```
::: column-body

\

\

# Train Station Upzoning Rankings: Executive Summary



\

Melbourne is going to have to make some choices soon about where to build more housing.

Locating new dwellings nearby to train stations as a form of Transit Oriented Development has emerged as a favoured solution by policymakers, with recent applications in Sydney.

However, policymakers face difficult choices in choosing which stations to upzone. For example, train stations close to the the city may be ideal for locating people near employment opportunities, although they may already be developed, or, the train line may lack spare passenger capacity. Stations further away may be less developed, although they might have poorer service frequencies or other nearby amenities.

The purpose of this report is to tackle these trade-offs by building a robust and data-driven framework to identify the train stations that are best suited for this broad upzoning.

### Methodology

\

For each train station, metrics are calculated on:

-   Zoning suitability (% land area)
-   Potential number of new homes (# homes)
-   Train service frequency in peak (trains per hour)
-   Spare train line capacity in peak (# passengers)
-   Local amenities nearby (composite index)
-   Proximity to CBD (metres)
-   Bus and tram frequencies (services per hour)

Each metric calculated uses different units of measurement, and need to be transformed into comparable units so that a single score can be generated for each train station.

This report uses xmin-xmax scaling, which transforms each 'raw' metric into a value between zero and one. If a station receives a 'transformed' score of zero, it corresponds to the lowest value out of all stations. Likewise, a value of one represents the best out of all stations in Melbourne.

These 'transformed' scores are summed together to produce a final score for each station.

::: callout-note

There are some restrictions placed on final rankings:

-   City loop stations are excluded as they can't be upzoned further.

-   Edge transfer stations (North Melbourne, South Yarra, Richmond) were excluded due to extreme outliers in the data impacting the transformation process.

-   Stations further than 25km of Flinders Street are excluded as they are generally economically unfeasible to upzone.

:::

The full methodology is contained in the full report.

### Key Result: Top 10 Train Stations

\

**`r transformed_scores %>% filter(rank == 1) %>% pull(station)`** was the best station out of those considered in this project.

There is a searchable table and interactive map at the foot of this document to find your own station and see where it ranks.

A map below shows the top 10 stations, with their values contained in the 'Chart' tab. One thing of note is how close many of the stations are in terms of final score, without a standout jump between the top 10.

::: column-page
::: panel-tabset
## Map


![](index_images/main.png)


## Chart

```{r}
 top_10_chart()
```

:::
:::

### Key result: Distribution by LGA

\

The best stations for upzoning are not equally distributed across Melbourne.

Local government areas in the inner south east, such as Stonnington & Boroondara, have the most stations in the top 25 ranking stations.

Hover over the bar chart below for an interactive effect.

:::

::: column-page

```{r}

top_stations_by_lga() 

```

:::

::: column-body

# In-Depth Analysis of Top 10 Stations

This next section will step through each 10 highest ranked stations. It will include a breakdown of how its score was formed, which uses the transformed scores discussed in the methodology section. These scores are bounded between zero and one.

A table below shows a *rough* guide of how to interpret the transformed scores.

| Transformed Value | Interpretation |
|-------------------|----------------|
| 0-0.35            | Poor           |
| 0.35 - 0.6        | Low            |
| 0.6 - 0.8         | Good           |
| 0.8 - 1           | Excellent      |

Use a laptop or desktop for the best viewing experience.
(keep scrolling!)
:::
::: cr-section
::: {focus-on="cr-map1"}
## [`r transformed_scores$station[1]`](%60r%20paste0('stations/',san_station(transformed_scores$station%5B1%5D),'/quarto/',san_station(transformed_scores$station%5B1%5D),'.html')%20%60)

###### Rank: 1

###### Total Score: `r transformed_scores$score[1]` / 7

\

```{r}

printScores(1)

```

See more information [here](%60r%20paste0('stations/',san_station(transformed_scores$station%5B1%5D),'/quarto/',san_station(transformed_scores$station%5B1%5D),'.html')%20%60).
:::

::: {focus-on="cr-map2"}
## [`r transformed_scores$station[2]`](%60r%20paste0('stations/',san_station(transformed_scores$station%5B2%5D),'/quarto/',san_station(transformed_scores$station%5B2%5D),'.html')%20%60)

###### Rank: 2

###### Total Score: `r transformed_scores$score[2]` / 7

\


```{r}

printScores(2)

```

See more information [here](%60r%20paste0('stations/',san_station(transformed_scores$station%5B2%5D),'/quarto/',san_station(transformed_scores$station%5B2%5D),'.html')%20%60).
:::

::: {focus-on="cr-map3"}
## [`r transformed_scores$station[3]`](%60r%20paste0('stations/',san_station(transformed_scores$station%5B3%5D),'/quarto/',san_station(transformed_scores$station%5B3%5D),'.html')%20%60)

###### Rank: 3

###### Total Score: `r transformed_scores$score[3]` / 7

\


```{r}

printScores(3)

```

See more information [here](%60r%20paste0('stations/',san_station(transformed_scores$station%5B3%5D),'/quarto/',san_station(transformed_scores$station%5B3%5D),'.html')%20%60).
:::

::: {focus-on="cr-map4"}
## [`r transformed_scores$station[4]`](%60r%20paste0('stations/',san_station(transformed_scores$station%5B4%5D),'/quarto/',san_station(transformed_scores$station%5B4%5D),'.html')%20%60)

###### Rank: 4

###### Total Score: `r transformed_scores$score[4]` / 7

\


```{r}

printScores(4)

```

See more information [here](%60r%20paste0('stations/',san_station(transformed_scores$station%5B4%5D),'/quarto/',san_station(transformed_scores$station%5B4%5D),'.html')%20%60).
:::

::: {focus-on="cr-map5"}
## [`r transformed_scores$station[5]`](%60r%20paste0('stations/',san_station(transformed_scores$station%5B5%5D),'/quarto/',san_station(transformed_scores$station%5B5%5D),'.html')%20%60)

###### Rank: 5

###### Total Score: `r transformed_scores$score[5]` / 7

\


```{r}

printScores(5)

```

See more information [here](%60r%20paste0('stations/',san_station(transformed_scores$station%5B5%5D),'/quarto/',san_station(transformed_scores$station%5B5%5D),'.html')%20%60).
:::

::: {focus-on="cr-map6"}
## [`r transformed_scores$station[6]`](%60r%20paste0('stations/',san_station(transformed_scores$station%5B6%5D),'/quarto/',san_station(transformed_scores$station%5B6%5D),'.html')%20%60)

###### Rank: 6

###### Total Score: `r transformed_scores$score[6]` / 7

\


```{r}

printScores(6)

```

See more information [here](%60r%20paste0('stations/',san_station(transformed_scores$station%5B6%5D),'/quarto/',san_station(transformed_scores$station%5B6%5D),'.html')%20%60).
:::

::: {focus-on="cr-map7"}
## [`r transformed_scores$station[7]`](%60r%20paste0('stations/',san_station(transformed_scores$station%5B7%5D),'/quarto/',san_station(transformed_scores$station%5B7%5D),'.html')%20%60)

###### Rank: 7

###### Total Score: `r transformed_scores$score[7]` / 7

\


```{r}

printScores(7)

```

See more information [here](%60r%20paste0('stations/',san_station(transformed_scores$station%5B7%5D),'/quarto/',san_station(transformed_scores$station%5B7%5D),'.html')%20%60).
:::

::: {focus-on="cr-map8"}
## [`r transformed_scores$station[8]`](%60r%20paste0('stations/',san_station(transformed_scores$station%5B8%5D),'/quarto/',san_station(transformed_scores$station%5B8%5D),'.html')%20%60)

###### Rank: 8

###### Total Score: `r transformed_scores$score[8]` / 7

\


```{r}

printScores(8)

```

See more information [here](%60r%20paste0('stations/',san_station(transformed_scores$station%5B8%5D),'/quarto/',san_station(transformed_scores$station%5B8%5D),'.html')%20%60).
:::

::: {focus-on="cr-map9"}
## [`r transformed_scores$station[9]`](%60r%20paste0('stations/',san_station(transformed_scores$station%5B9%5D),'/quarto/',san_station(transformed_scores$station%5B9%5D),'.html')%20%60)

###### Rank: 9

###### Total Score: `r transformed_scores$score[9]` / 7

\


```{r}

printScores(9)

```

See more information [here](%60r%20paste0('stations/',san_station(transformed_scores$station%5B9%5D),'/quarto/',san_station(transformed_scores$station%5B9%5D),'.html')%20%60).
:::

::: {focus-on="cr-map10"}
## [`r transformed_scores$station[10]`](%60r%20paste0('stations/',san_station(transformed_scores$station%5B10%5D),'/quarto/',san_station(transformed_scores$station%5B10%5D),'.html')%20%60)

###### Rank: 10

###### Total Score: `r transformed_scores$score[10]` / 7

\


```{r}

printScores(10)

```

See more information [here](%60r%20paste0('stations/',san_station(transformed_scores$station%5B10%5D),'/quarto/',san_station(transformed_scores$station%5B10%5D),'.html')%20%60).
:::

::: {focus-on="cr-click"}
## Clickable Map

You can find more details about your own local station by zooming in on the map and clicking on the label.

Alternatively, use the searchable table below.

## Searchable Table

```{r}

# transformed_scores %>%
#   select(station, score) %>%
#   reactable(theme = cyborg(),
#             class = "pageinforeactable",
#             columns = list(
#               'station' = colDef(name = 'station'),
#               'score' = colDef(name = "Score",
#                              cell = data_bars(.,
#                                               fill_color = 'white',
#                                               background = 'opaque'))
#             )
#             
#             )



# readRDS('../r_objects/transformed_scores.Rdata') %>%
#   as.data.frame() %>%
#   mutate(across(where(is.numeric), ~round(.x, 2))) %>%
#   rename(!!!translations) %>%
#   reactable(theme = sandstone(),searchable = T, defaultSorted = "Total Score", defaultSortOrder = "desc", defaultPageSize = 10)

 df_with_links = readRDS('../r_objects/transformed_scores.Rdata')  %>%
  as.data.frame() %>%
  select(station) %>%
  mutate(safe_name = gsub("[^a-zA-Z0-9]", "_", station)) %>%
  mutate(win_url = paste0('stations/', safe_name, '/quarto/', safe_name, '.html')) %>%
  select(-safe_name)

reactable(df_with_links,
          filterable = T,
  columns = list(
    station = colDef(
      name = "Station",
      cell = function(value, index) {
        url <- df_with_links$win_url[index]
        htmltools::a(href = url, value, target = "_blank")
      }
    ),
    win_url = colDef(show = FALSE)  # Hide the URL column
  )
)

```
:::

::: {#cr-main}
:::

::: {#cr-map1}
:::

::: {#cr-map2}
:::

::: {#cr-map3}
:::

::: {#cr-map4}
:::

::: {#cr-map5}
:::

::: {#cr-map6}
:::

::: {#cr-map7}
:::

::: {#cr-map8}
:::

::: {#cr-map9}
:::

::: {#cr-map10}
:::

::: {#cr-click}
```{r}

colours = tribble(
  ~group, ~ colour,
  'Sandringham' , "#F178AF",
  'CrossCity' , "#028430",
  'Cran/Pak' , "#279FD5",
  "Burnley" , "#152C6B",
  "Northern" , "#FFBE00",
  "Eastern" , "#BE1014",
  'event' , "#95979A"
)

lines_dissolved <- read_sf('../shapefiles/qgis/final_map.shp') %>%
  left_join(colours, by = 'group') 


locations = locations %>%
  mutate(safe_name = gsub("[^a-zA-Z0-9]", "_", Station_Name)) %>%
  mutate(message = 
           paste0(
             '<div style = \" background-color: black; \">',
             "<p style = \" color: white; text-align:center ; padding: 5px; \" >", Station_Name, '</p>',
             '</div>'
             
           )
  ) %>%
  mutate(win_url = paste0('stations/', safe_name, '/quarto/', safe_name, '.html'))



js_code <- "
function(el, x, data) {

    var marker = document.getElementsByClassName('my-labels');
  for(var i=0; i < marker.length; i++){
    (function(){
      console.log('hello');
      var v = data.win_url[i];
      marker[i].addEventListener('click', function() { window.open(v);}, false);
  }()); 
  }

  var map = this;
  
  
// Optional: Re-enable scrolling when mouse enters the map
map.on('mouseenter', function() {
    if (!document.getElementById('cr-click').classList.contains('cr-active')) {
        map.scrollWheelZoom.enable();
        console.log('a');
    }
});

// Optional: Disable scrolling again when mouse leaves the map
map.on('mouseleave', function() {
    if (!document.getElementById('cr-click').classList.contains('cr-active')) {
        map.scrollWheelZoom.disable();
        console.log('b');
    }
});
  
  function updateMapScrolling() {
     var crClickDiv = document.getElementById('cr-click');
    var mapContainer = map.getContainer();
    
    if (crClickDiv.classList.contains('cr-active')) {
        // Enable map interaction
        map.scrollWheelZoom.enable();
        map.dragging.enable();
        map.touchZoom.enable();
        map.doubleClickZoom.enable();
        map.boxZoom.enable();
        map.keyboard.enable();
        if (map.tap) map.tap.enable();
        mapContainer.style.pointerEvents = 'auto';
    } else {
        // Disable all map interaction
        map.scrollWheelZoom.disable();
        map.dragging.disable();
        map.touchZoom.disable();
        map.doubleClickZoom.disable();
        map.boxZoom.disable();
        map.keyboard.disable();
        if (map.tap) map.tap.disable();
        mapContainer.style.pointerEvents = 'none';
    }
  }
  

  function updateLabelVisibility() {
   
    var currentZoom = map.getZoom();
   
    var showLabelsZoomLevel = 13;

    var labels = document.getElementsByClassName('leaflet-tooltip');
   
    for (var i = 0; i < labels.length; i++) {
      if (currentZoom >= showLabelsZoomLevel) {
        labels[i].style.display = 'block';
      } else {
        labels[i].style.display = 'none';
      }
    }
  }
  
  // Initial setup
updateMapScrolling();

// Add event listener to check for class changes
var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            updateMapScrolling();
            console.log('cr click updated status');
        }
    });
});

var crClickDiv = document.getElementById('cr-click');
observer.observe(crClickDiv, { attributes: true });

  // Ensure the map is fully loaded before adding the event listener
  map.whenReady(function() {
  
  
 
    map.on('zoomend', function() {
  
      updateLabelVisibility();
    });
    
    // Initial call to set correct visibility
    updateLabelVisibility();
  });
}






"

m <- leaflet(width = '100%', height = '100vh') %>%
  leaflet::setView(lng = 144.9668, lat = -37.8181, zoom = 12) %>%
  addPolylines(data = lines_dissolved, color = ~colour, opacity = 1) %>%
  addTiles('https://tiles.stadiamaps.com/tiles/stamen_toner_background/{z}/{x}/{y}.png?api_key=090a847c-32a2-4e35-99a9-543ad8f4ecc8', options = tileOptions(opacity = 0.5)) %>%
  addCircleMarkers(lng = locations$lng, lat=locations$lat, radius = 5, color = 'black', fillColor = 'black', fillOpacity = 1, opacity = 0.7) %>%
  addLabelOnlyMarkers(lng = locations$lng,
                      lat = locations$lat,
                      label = lapply(locations$message, htmltools::HTML),
                      labelOptions = labelOptions(noHide = T, clickable = T,  className = 'my-labels', direction = 'auto', textOnly = T, textsize = '10pt',
                                                  style = list(
                                                    'font-weight' = '800',
                                                    'text-decoration' = 'underline',
                                                    'text-decoration-color' = 'white',
                                                    'margin' = '5px',
                                                    'letter-spacing' = '0.5px'
                                                  ))) %>%
  htmlwidgets::onRender(js_code, data = locations) 

m

```
:::
:::
